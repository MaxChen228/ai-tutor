{% extends "admin/base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="h3 mb-4">
            <i class="fas fa-cogs text-primary me-2"></i>
            批次處理管理
        </h1>
    </div>
</div>

<!-- 狀態概覽 -->
<div class="row g-4 mb-5">
    <div class="col-md-4">
        <div class="card text-center h-100">
            <div class="card-body">
                <i class="fas fa-clock fa-2x text-warning mb-3"></i>
                <h4 class="card-title">待處理</h4>
                <div class="fs-2 fw-bold text-warning">{{ pending_count }}</div>
                <p class="card-text text-muted">個知識點需要生成向量</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card text-center h-100">
            <div class="card-body">
                <i class="fas fa-play fa-2x text-primary mb-3"></i>
                <h4 class="card-title">處理狀態</h4>
                <div class="fs-4 fw-bold" id="processingStatus">待啟動</div>
                <div class="progress mt-2" style="height: 10px;">
                    <div class="progress-bar" id="progressBar" role="progressbar" 
                         style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card text-center h-100">
            <div class="card-body">
                <i class="fas fa-chart-line fa-2x text-success mb-3"></i>
                <h4 class="card-title">預估時間</h4>
                <div class="fs-4 fw-bold text-success" id="estimatedTime">
                    {{ "%.1f"|format(pending_count * 0.5) }} 分鐘
                </div>
                <p class="card-text text-muted">基於歷史處理速度</p>
            </div>
        </div>
    </div>
</div>

<!-- 批次處理控制 -->
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-settings text-primary me-2"></i>
                    處理設定
                </h5>
            </div>
            <div class="card-body">
                <form id="batchProcessForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="batchSize" class="form-label">批次大小</label>
                            <select class="form-select" id="batchSize" name="batch_size">
                                <option value="50">50 個知識點</option>
                                <option value="100" selected>100 個知識點</option>
                                <option value="200">200 個知識點</option>
                                <option value="0">全部處理</option>
                            </select>
                            <div class="form-text">選擇每次處理的知識點數量</div>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="similarityThreshold" class="form-label">相似度閾值</label>
                            <input type="range" class="form-range" id="similarityThreshold" 
                                   min="0.6" max="0.9" step="0.05" value="0.8">
                            <div class="d-flex justify-content-between">
                                <small>0.6 (寬鬆)</small>
                                <small id="thresholdValue">0.8</small>
                                <small>0.9 (嚴格)</small>
                            </div>
                            <div class="form-text">用於自動建立關聯的最低相似度</div>
                        </div>
                        
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="autoLink" checked>
                                <label class="form-check-label" for="autoLink">
                                    自動建立知識點關聯
                                </label>
                                <div class="form-text">處理完成後自動尋找並建立相似知識點的關聯</div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-play text-success me-2"></i>
                    執行控制
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-3">
                    <button class="btn btn-success btn-lg" id="startProcessing" onclick="startBatchProcessing()">
                        <i class="fas fa-play me-2"></i>
                        開始處理
                    </button>
                    
                    <button class="btn btn-warning" id="pauseProcessing" onclick="pauseProcessing()" style="display: none;">
                        <i class="fas fa-pause me-2"></i>
                        暫停處理
                    </button>
                    
                    <button class="btn btn-outline-danger" onclick="clearProcessing()">
                        <i class="fas fa-trash me-2"></i>
                        清除進度
                    </button>
                </div>
                
                <hr>
                
                <div class="text-center">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        處理過程中請保持頁面開啟
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 處理日誌 -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-list-alt text-info me-2"></i>
                    處理日誌
                </h5>
                <button class="btn btn-sm btn-outline-secondary" onclick="clearLog()">
                    <i class="fas fa-eraser me-1"></i>清除日誌
                </button>
            </div>
            <div class="card-body">
                <div id="processingLog" style="height: 300px; overflow-y: auto; background-color: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 0.9em;">
                    <div class="text-muted">等待開始處理...</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let processingInterval = null;
let currentBatch = 0;
let totalBatches = 0;
let isProcessing = false;

// 更新相似度閾值顯示
document.getElementById('similarityThreshold').addEventListener('input', function() {
    document.getElementById('thresholdValue').textContent = this.value;
});

function addLog(message, type = 'info') {
    const log = document.getElementById('processingLog');
    const timestamp = new Date().toLocaleTimeString();
    const colorClass = type === 'error' ? 'text-danger' : type === 'success' ? 'text-success' : 'text-primary';
    
    const logEntry = document.createElement('div');
    logEntry.innerHTML = `<span class="text-muted">[${timestamp}]</span> <span class="${colorClass}">${message}</span>`;
    
    log.appendChild(logEntry);
    log.scrollTop = log.scrollHeight;
}

function updateProgress(current, total) {
    const percentage = total > 0 ? Math.round((current / total) * 100) : 0;
    const progressBar = document.getElementById('progressBar');
    
    progressBar.style.width = percentage + '%';
    progressBar.setAttribute('aria-valuenow', percentage);
    
    document.getElementById('processingStatus').textContent = 
        isProcessing ? `處理中 ${current}/${total}` : '已完成';
}

function startBatchProcessing() {
    const form = document.getElementById('batchProcessForm');
    const formData = new FormData(form);
    const batchSize = parseInt(document.getElementById('batchSize').value);
    const threshold = parseFloat(document.getElementById('similarityThreshold').value);
    const autoLink = document.getElementById('autoLink').checked;
    
    // 更新UI狀態
    isProcessing = true;
    document.getElementById('startProcessing').style.display = 'none';
    document.getElementById('pauseProcessing').style.display = 'block';
    
    addLog(`開始批次處理，批次大小: ${batchSize || '全部'}，相似度閾值: ${threshold}`, 'info');
    
    // 計算總批次數
    const pendingCount = {{ pending_count }};
    totalBatches = batchSize > 0 ? Math.ceil(pendingCount / batchSize) : 1;
    currentBatch = 0;
    
    // 開始處理
    processBatch(batchSize, threshold, autoLink);
}

function processBatch(batchSize, threshold, autoLink) {
    if (!isProcessing) {
        addLog('處理已暫停', 'info');
        return;
    }
    
    currentBatch++;
    addLog(`正在處理第 ${currentBatch}/${totalBatches} 批次...`, 'info');
    updateProgress(currentBatch - 1, totalBatches);
    
    fetch('/admin/api/batch-process', {
        method: 'POST',
        headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('jwt_token'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ 
            limit: batchSize > 0 ? batchSize : null,
            similarity_threshold: threshold,
            auto_link: autoLink
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            const result = data.result;
            addLog(`第 ${currentBatch} 批次完成 - 成功: ${result.success}, 失敗: ${result.failed}`, 'success');
            
            updateProgress(currentBatch, totalBatches);
            
            // 檢查是否還有更多要處理
            if (result.processed > 0 && currentBatch < totalBatches && isProcessing) {
                // 繼續下一批次
                setTimeout(() => processBatch(batchSize, threshold, autoLink), 1000);
            } else {
                // 完成所有處理
                finishProcessing();
            }
        } else {
            addLog(`第 ${currentBatch} 批次失敗: ${data.error}`, 'error');
            finishProcessing();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        addLog(`第 ${currentBatch} 批次發生錯誤: ${error.message}`, 'error');
        finishProcessing();
    });
}

function finishProcessing() {
    isProcessing = false;
    document.getElementById('startProcessing').style.display = 'block';
    document.getElementById('pauseProcessing').style.display = 'none';
    
    updateProgress(totalBatches, totalBatches);
    addLog('所有批次處理完成！', 'success');
    
    // 重新載入頁面以更新統計
    setTimeout(() => {
        window.location.reload();
    }, 2000);
}

function pauseProcessing() {
    isProcessing = false;
    document.getElementById('startProcessing').style.display = 'block';
    document.getElementById('pauseProcessing').style.display = 'none';
    
    addLog('處理已暫停', 'info');
}

function clearProcessing() {
    if (confirm('確定要清除處理進度嗎？')) {
        isProcessing = false;
        currentBatch = 0;
        totalBatches = 0;
        
        document.getElementById('startProcessing').style.display = 'block';
        document.getElementById('pauseProcessing').style.display = 'none';
        
        updateProgress(0, 100);
        document.getElementById('processingStatus').textContent = '待啟動';
        
        addLog('處理進度已清除', 'info');
    }
}

function clearLog() {
    document.getElementById('processingLog').innerHTML = '<div class="text-muted">日誌已清除</div>';
}

// 頁面離開前的警告
window.addEventListener('beforeunload', function(e) {
    if (isProcessing) {
        e.preventDefault();
        e.returnValue = '批次處理正在進行中，確定要離開嗎？';
    }
});
</script>
{% endblock %}